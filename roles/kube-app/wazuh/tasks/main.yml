- name: check if wazuh namespace exists
  become: yes
  become_method: sudo
  kubernetes.core.k8s_info:
    kind: namespace
    name: wazuh
  register: __wazuh_namespace
  changed_when: False
  ignore_errors: yes

- name: Open firewalld port on all worker nodes
  become: yes
  become_method: sudo
  shell: "firewall-cmd --permanent --add-port=1514/tcp --add-port=1515/tcp --add-port=55000/tcp --add-port=9200/tcp"
  delegate_to: "{{ item }}"
  loop: "{{ groups['k8s_workers'] }}"

- name: Restart firewalld on all worker nodes
  become: yes
  become_method: sudo
  shell: "firewall-cmd --reload"
  delegate_to: "{{ item }}"
  loop: "{{ groups['k8s_workers'] }}"

- name: Open SELinux port on all worker nodes
  become: yes
  become_method: sudo
  shell: "semanage port -a -t http_port_t -p tcp 1514 && semanage port -a -t http_port_t -p tcp 1515 && semanage port -a -t http_port_t -p tcp 55000 && semanage port -a -t http_port_t -p tcp 9200"
  delegate_to: "{{ item }}"
  loop: "{{ groups['k8s_workers'] }}"

- name: check if git exists
  command: git --version
  register: __git_exists
  ignore_errors: yes
  changed_when: False

- name: install git
  become: yes
  become_method: sudo
  yum:
    name: git
    state: present
  when: __git_exists.rc != 0

- name: check if repository is clone
  stat:
    path: /tmp/wazuh-kubernetes
  register: __wazuh_repo

- name: delete repository
  become: yes
  become_method: sudo
  command: rm -rf /tmp/wazuh-kubernetes
  when: __wazuh_repo.stat.exists == True

- name: install wazuh
  when: __wazuh_namespace.resources | length == 0
  become: yes
  become_method: sudo
  block:
    - name: clone wazuh repo
      git:
        repo: https://github.com/wazuh/wazuh-kubernetes.git
        dest: /tmp/wazuh-kubernetes

    - name: generate index certificates
      command: /tmp/wazuh-kubernetes/wazuh/certs/indexer_cluster/generate_certs.sh

    - name: generate dashboard certificates
      command: /tmp/wazuh-kubernetes/wazuh/certs/dashboard_http/generate_certs.sh

    - name: changing ownership of certificates
      command: chown -R admintranet:admintranet /tmp/wazuh-kubernetes/wazuh/certs

    - name: Modify provisioner class
      lineinfile:
        path: /tmp/wazuh-kubernetes/envs/local-env/storage-class.yaml
        regexp: "provisioner: kubernetes.io/no-provisioner"
        line: "provisioner: microk8s.io/hostpath"

    - name: change version in deployment with replace
      become: yes
      become_method: sudo
      loop:
        - { path: "wazuh_managers/wazuh-worker-sts.yaml", container: "wazuh/wazuh-manager" }
        - { path: "wazuh_managers/wazuh-master-sts.yaml", container: "wazuh/wazuh-manager" }
        - { path: "indexer_stack/wazuh-indexer/cluster/indexer-sts.yaml", container: "wazuh/wazuh-indexer" }
        - { path: "indexer_stack/wazuh-dashboard/dashboard-deploy.yaml", container: "wazuh/wazuh-dashboard" }
      replace:
        path: "/tmp/wazuh-kubernetes/wazuh/{{ item.path }}"
        regexp: "{{ item.container }}:5.0.0"
        replace: "{{ item.container }}:4.9.2"

    - name: Edit service (add external IP) [LB]
      lineinfile:
        path: "/tmp/wazuh-kubernetes/wazuh/{{ item.path }}"
        insertafter: "EOF"
        regexp: "^"
        line: "  externalIPs: ['{{ item.ip }}']"
      loop:
        - { path: "wazuh_managers/wazuh-master-svc.yaml",  ip: "10.0.0.30" }
        - { path: "indexer_stack/wazuh-indexer/cluster/indexer-api-svc.yaml",  ip: "10.0.0.30" }
        - { path: "wazuh_managers/wazuh-workers-svc.yaml", ip: "10.0.0.30" }

    - name: Edit service [ClusterIP]
      replace:
        path: /tmp/wazuh-kubernetes/wazuh/indexer_stack/wazuh-dashboard/dashboard-svc.yaml
        regexp: "LoadBalancer"
        replace: "ClusterIP"

    - name: build wazuh manifest with kustomize
      shell: "kustomize build /tmp/wazuh-kubernetes/envs/local-env > /tmp/wazuh.yaml"

    - name: apply wazuh
      become: yes
      become_method: sudo
      shell: "kubectl apply -f /tmp/wazuh.yaml"

    - name: Creating pv
      include_tasks: create_pv.yml
      loop:
        - { name: "wazuh-index-pv", size: "10Gi", claim_name: "wazuh-indexer-wazuh-indexer-0", path: "{{ wazuh_pv_index_path }}" }
        - { name: "wazuh-manager-master-0-pv", size: "5Gi", claim_name: "wazuh-manager-master-wazuh-manager-master-0",path: "{{ wazuh_pv_manager_master_path }}" }
        - { name: "wazuh-manager-worker-0-pv", size: "5Gi", claim_name: "wazuh-manager-worker-wazuh-manager-worker-0",path: "{{ wazuh_pv_manager_worker_path }}" }

    - name: clean up
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/wazuh-kubernetes
        - /tmp/wazuh.yaml


- name: check if wazuh cert secret exists
  become: yes
  become_method: sudo
  kubernetes.core.k8s_info:
    kind: secret
    name: wazuh-selfsigned
    namespace: wazuh
  register: __wazuh_cert
  changed_when: False
  ignore_errors: yes

- name: Create wazuh cert secret
  when: __wazuh_cert.resources | length == 0
  block:
    - name: Generate self-signed certificate
      command: 'openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /tmp/wazuh.key -out /tmp/wazuh.crt -subj "/CN={{ wazuh_ingress_host }}/O={{ wazuh_ingress_host }}" -addext "subjectAltName = DNS:{{ wazuh_ingress_host }}"'

    #kubectl create secret -n wazuh tls wazuh-selfsigned --key=/tmp/wazuh.key --cert=/tmp/wazuh.crt
    - name: create kube secret for wazuh cert
      become: yes
      become_method: sudo
      shell: "kubectl create secret -n wazuh tls wazuh-selfsigned --key=/tmp/wazuh.key --cert=/tmp/wazuh.crt"

    - name: Clean up
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/wazuh.key
        - /tmp/wazuh.crt

- name: Check if ingress exist
  become: yes
  become_method: sudo
  kubernetes.core.k8s_info:
    kind: Ingress
    name: wazuh-ingress
    namespace: wazuh
  register: __wazuh_ingress
  changed_when: False
  ignore_errors: yes

- name: Create ingress
  become: yes
  become_method: sudo
  when: __wazuh_ingress.resources | length == 0
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: wazuh-ingress
        namespace: wazuh
        annotations:
          nginx.ingress.kubernetes.io/rewrite-target: /
          nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
      spec:
        tls:
          - hosts:
              - "{{ wazuh_ingress_host }}"
            secretName: wazuh-selfsigned
        ingressClassName: "nginx"
        rules:
          - host: "{{ wazuh_ingress_host }}"
            http:
              paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: dashboard
                      port:
                        number: 443
